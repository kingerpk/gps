<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>货场监控</title>
	<script src="js/jquery.js"></script>
    <script src="js/OpenLayers-2.12/OpenLayers.js"></script>
    <script type="text/javascript">
		   var i=1;//测试gps数据用
		   var temLayer;
		   var GpsLineLayer;//gps路线图层
		   var pointEndLayer;//线头，也就是表示那个人当前的位置
		   var mapname="a29";//地图名
		   var localhost="http://localhost:8080/geoserver";
		   var map //地图对象
		   var interval_control;//定时器对象
		   var timeToClear=60000*10;//间隔多长时间情况gps点，10分钟
		   var lastTimeClear=null;//上一次清空时间
		   var railway=null;
		   
        function init(){
			jQuery.getScript("./data/"+mapname+"_mapArg.js")
            map=loadMap();//加载地图
			addGraphicsLayer(map);//加载gps图层
			var mousep=new OpenLayers.Control.MousePosition();//显示鼠标位置的控件
			map.addControl(mousep);
			temLayer.setVisibility(false);
        }
		
		/*
		*加载地图
		*/
		function loadMap(){
				 var bounds = new OpenLayers.Bounds(
                    112.95420151037503, 28.111840983208282,
                    112.95652135770875, 28.112519811193188
                );
			 
                var options = {
					maxExtent: bounds,
					maxResolution: 0.0000090619036474
				 };
				
			var loadmap = new OpenLayers.Map('map',options);		
		
			railway = new OpenLayers.Layer.WMS(
								"Global Imagery",
								localhost+"/wms?service=WMS",
								 {layers: "cite:"+mapname+"_new"},
								 {singleTile:true}
							);
			temLayer=new OpenLayers.Layer.Vector("temLayer",{
				strategies: [new OpenLayers.Strategy.BBOX()],
				protocol: new OpenLayers.Protocol.WFS({
                    url: "http://localhost:8080/geoserver/ows",
                    featureType: "a29_cp",
                    featureNS: "http://www.opengeospatial.net/cite"
                })				
			 });
			 
				
			/*nouse=new OpenLayers.Layer.Vector("tem1",{
				strategies: [new OpenLayers.Strategy.BBOX()],
				protocol: new OpenLayers.Protocol.WFS({
                    url: "http://localhost:8080/geoserver/ows",
                    featureType: "a29_cp",
                    featureNS: "http://www.opengeospatial.net/cite"
                })				
			 });*/
		
						 
			 loadmap.addLayers([railway,temLayer]);
			
                loadmap.addControl(new OpenLayers.Control.MousePosition({element: $('location')}));
                loadmap.zoomToExtent(bounds);
			 loadmap.setCenter(new OpenLayers.LonLat(112.955,28.112),2);
			 

			 return loadmap;
		}
		
		
		/*
		*加载gps图层
		*/
		function addGraphicsLayer(map_to_add){
			GpsLineLayer=new OpenLayers.Layer.Vector();//初始化矢量图层
			pointEndLayer=new OpenLayers.Layer.Vector("point",{
							styleMap: new OpenLayers.StyleMap({
										"default":new OpenLayers.Style({
													pointRadius:4,
													fillColor: "#ff9933",
													strokeColor: "white",
													strokeWidth: 6,
													label:'${id}',
													labelXOffset: "-15",
													labelYOffset: "15",
													externalGraphic: "img/${id}.jpg"
												}),	
										"select": new OpenLayers.Style({
													fillColor: "#66ccff",
													strokeColor: "#3399ff",
													graphicZIndex: 2
												})
								})//初始化矢量图层
			});
			map_to_add.addLayers([GpsLineLayer,pointEndLayer]);//将矢量图层添加到地图	
		}
		
		/*
		*定时获取gps数据，问题，如果gps数据没有变化，也就是说服务器返回来的数据时旧的，这里是显示还是不显示呢？
		*/
		function StartGps(){
				interval_control=window.setInterval(function(){showCurrentGps()},1000); 
		}
		
		/*
		*向服务器请求最新的gps数据，然后在地图显示
		*/
		function showCurrentGps(gpsobj){
			var gpsData=gpsobj;
			if(!gpsData){return;}
			for(var j in gpsData){
				var gps=gpsData[j];//这里代表一个gps设备的当前位置信息
				var features=GpsLineLayer.getFeaturesByAttribute("id",gps.id);//从gps图层中查找对应id设备号的feature
				var oldPoint=pointEndLayer.getFeaturesByAttribute("id",gps.id);//获取对应的点头
				var lastTime=readTimeStr(gps.gps[gps.gps.length-1].time);
				if(lastTimeClear==null)lastTimeClear=lastTime;
				if((lastTime-lastTimeClear)>=timeToClear)clearGps();//达到时间了清空所有数据
				var point=conventPoint2(gps.gps[gps.gps.length-1].lon,gps.gps[gps.gps.length-1].lat);//根据当前的坐标初始化点
				pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point,{id:gps.id,time:lastTime})]);
				pointEndLayer.removeFeatures(oldPoint);//将对应id的点头去掉
				var resultgeo=null;
				var newgeo = getGpsGeometry(gps.gps);
				if(features.length>0){
					var oldgeo = features[0].geometry
					resultgeo=builtGeometry(newgeo,oldgeo);
				}
				else{
					resultgeo=newgeo;
				}
				var feature=new OpenLayers.Feature.Vector(resultgeo,{id:gps.id});
				GpsLineLayer.removeFeatures(features);
				GpsLineLayer.addFeatures(feature);
				
			}
			i++;
		}
		
		function builtGeometry(newgeo,oldgeo){
			if(!newgeo||!oldgeo){
				return null;
			}
			var points=oldgeo.getVertices();//这个feature的图形是一个折线，从折线中取点
			var newpoints=newgeo.getVertices();
			if(points.length==1){
				//如果点的数量只有一，那么先将这个旧点和当前的gps点构造成一条线，在构造成折线
				var pointO=points[0];//获取那个唯一的点
				if(newpoints.length==1){
					var newLine=new OpenLayers.Geometry.LineString([pointO,newgeo]);//生成线
					var mline=new OpenLayers.Geometry.MultiLineString([newLine]);//构造成折线
					return mline;
				}
				else{
					var line=newgeo.components[newgeo.components.length-1];//获取折线中的最后一条线
					var points=line.getVertices();//拿到这条线的两个点
					var newLine=new OpenLayers.Geometry.LineString([points[points.length-1],pointO]);//把当前的gps点和这条线的最后一个点组成新的线
					newgeo.addComponents(newLine);//将这条线加入到折线中
					return newgeo;
				}
			}
			else{
				if(newpoints.length==1){
					var line=oldgeo.components[oldgeo.components.length-1];//获取折线中的最后一条线
					var points=line.getVertices();//拿到这条线的两个点
					var newLine=new OpenLayers.Geometry.LineString([points[points.length-1],newgeo]);//把当前的gps点和这条线的最后一个点组成新的线
					oldgeo.addComponents(newLine);//将这条线加入到折线中
					return oldgeo;
				}
				else{
					var line=oldgeo.components[oldgeo.components.length-1];//获取折线中的最后一条线
					var points=line.getVertices();//拿到这条线的两个点
					var lineN=newgeo.components[0];
					var pointsN=lineN.getVertices();//拿到这条线的两个点
					var newLine=new OpenLayers.Geometry.LineString([points[1],pointsN[0]]);//把当前的gps点和这条线的最后一个点组成新的线
					oldgeo.addComponents(newLine);//将这条线加入到折线中
					oldgeo.addComponents(newgeo.components);
					return oldgeo;
				}
			}
		}
		
		//将形如‘2012-9-1T10-32-29’的时间字符串格式化成时间对象
		function readTimeStr(timeStr){
			var ts=timeStr.split("T");
			var dateS=ts[0].split("-");
			var timeS=ts[1].split("-");
			var date=new Date();
			date.setFullYear(dateS[0]);
			date.setMonth(dateS[1]);
			date.setDate(dateS[2]);
			date.setHours(timeS[0]);
			date.setMinutes(timeS[1]);
			date.setSeconds(timeS[2]);
			return date;
		}
		
		/*
		*将图层中的feature清除
		*/
		function clearGps(){
			GpsLineLayer.removeAllFeatures();
			pointEndLayer.removeAllFeatures();
		}
		
		
		function stopShowGps(){
			clearInterval(interval_control);
		}
		
		function getGpsGeometry(gpss){
			if(gpss.length==1){
			
				var point1=conventPoint2(gpss[0].lon,gpss[0].lat);
				return point1;
			}
			var lines=new Array();
			for(var u=0;u<gpss.length-1;u++){
				var point1=conventPoint2(gpss[u].lon,gpss[u].lat,"gt");
				var point2=conventPoint2(gpss[u+1].lon,gpss[u+1].lat,"gt");
				var line=new OpenLayers.Geometry.LineString([point1,point2]);
				lines.push(line);
			}
			var mLine=new OpenLayers.Geometry.MultiLineString(lines);
			return mLine;
		}
		
		/*
		*将给定的一系列gps数据显示在地图上
		*/
		function addGpsData(gpsData){
			if(!gpsData){return;}
			clearGps();
			for(var j in gpsData){
				var data=gpsData[j];
				var gpss=data.gps;
				if(gpss.length==1){
				
					var point1=new OpenLayers.Geometry.Point(gpss[0].lon,gpss[0].lat);
					pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point1,{id:data.id})]);
					continue;
				}
				var lines=new Array();
				for(var u=0;u<gpss.length-1;u++){
					var point1=new OpenLayers.Geometry.Point(gpss[u].lon,gpss[u].lat,"gt");
					var point2=new OpenLayers.Geometry.Point(gpss[u+1].lon,gpss[u+1].lat,"gt");
					var line=new OpenLayers.Geometry.LineString([point1,point2]);
					pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point1,{id:data.id})]);
					lines.push(line);
				}
				var mLine=new OpenLayers.Geometry.MultiLineString(lines);
				var feature=new OpenLayers.Feature.Vector(mLine,{id:data.id});
				GpsLineLayer.addFeatures(feature);

			}
		}
		
		function conventPoint2(x,y){
			var point=conventPoint(x,y);
			var calcPointArg;
			for(var i in temLayer.features){
				var feature=temLayer.features[i];
				var geometry=feature.geometry;
				
				if(geometry.intersects(point)){
					var id=feature.attributes["Id"];
					var mArgs=mapArgs["a"+id];
					if(mArgs.result){
						return new OpenLayers.Geometry.Point(mArgs.result[0],mArgs.result[1]);
					}
					var distanctTop=mArgs.h.ys*calcDistance(point.x,point.y,mArgs.p1.yt[0],mArgs.p1.yt[1],mArgs.p4.yt[0],mArgs.p4.yt[1])/mArgs.h.yt;
					var distanctButtom=mArgs.h.ys*calcDistance(point.x,point.y,mArgs.p2.yt[0],mArgs.p2.yt[1],mArgs.p3.yt[0],mArgs.p3.yt[1])/mArgs.h.yt;
					var distanceLeft=mArgs.w.ys*calcDistance(point.x,point.y,mArgs.p1.yt[0],mArgs.p1.yt[1],mArgs.p2.yt[0],mArgs.p2.yt[1])/mArgs.w.yt;
					var distanceRight=mArgs.w.ys*calcDistance(point.x,point.y,mArgs.p3.yt[0],mArgs.p3.yt[1],mArgs.p4.yt[0],mArgs.p4.yt[1])/mArgs.w.yt;
					var newY;
					var newX;
					
					if(distanctTop<distanctButtom){
						newY=mArgs.p1.ys[1]-distanctTop;
					}
					else{
						newY=mArgs.p2.ys[1]+distanctButtom;
					}
					
					if(distanceLeft<distanceRight){
						var newXInfo=calcX(newY,mArgs.p1.ys[0],mArgs.p1.ys[1],mArgs.p2.ys[0],mArgs.p2.ys[1],distanceLeft);
						newX=newXInfo[1]+newXInfo[0];
					}
					else{
						var newXInfo=calcX(newY,mArgs.p3.ys[0],mArgs.p3.ys[1],mArgs.p4.ys[0],mArgs.p4.ys[1],distanceRight);
						newX=newXInfo[1]-newXInfo[0];
					}
					
					
					
					return new OpenLayers.Geometry.Point(newX,newY);
				}
			}
		}
		
		function calcDistance(Cx,Cy,Ax,Ay,Bx,By){
			var k=(By-Ay)/(Bx-Ax);
			var x=(Cy-Ay+k*Ax+Cx/k)/(k+1/k);
			var y=Cy-(x-Cx)/k;
			var result= Math.sqrt(Math.pow((x-Cx),2)+Math.pow((y-Cy),2));
			return result;
		}
		
		function calcX(Cy,Ax,Ay,Bx,By,distance){
			var k=(By-Ay)/(Bx-Ax);
			var d=-distance/k;
			var xd=Math.sqrt((distance*distance+d*d));
			var xOnLine=(Bx-Ax)*(Cy-Ay)/(By-Ay)+Ax;
			return [xd,xOnLine];
		}
		
		function calcDistanceBUP(x0,y0,x1,y1,x2,y2){
			 var result=Math.abs((x2-x1)*(y0-y1)-( x0-x1)*(y2-y1)) / Math.sqrt(Math.pow((x2-x1),2) +Math.pow((y2-y1),2));
			return result;
		}
		
		function conventPoint(x,y){
			  var ox=112.954258541;
			  var oy=28.113876232;
			  var sx=0.4;
			  var sy=9;
			  var rd= 83.2;
			  var d=rd*Math.PI/180;
			  var tx=(x-ox)*Math.cos(d)+(y-oy)*Math.sin(d)+ox;
			  var ty=-(x-ox)*Math.sin(d)+(y-oy)*Math.cos(d)+oy;
			  
			  var tw=(tx-ox)*sx;
			  var th=(ty-oy)*sy;
			  tx=(ox+tw);
			  ty=(oy+th);
			  var point=new OpenLayers.Geometry.Point(tx,ty);
			  return point;
		}
		
		/*
		*获取gps数据
		*/
		function loadGpsData(name){
			if(name==1){
				return gpsData1;
			}
			
			return gpsData2;
		}
		
		function test(){
			var gdstr=$("#gd").attr("value");
			var gpsdata=eval(gdstr);
			showCurrentGps(gpsdata);
		}
		
		function addpoint(x,y){
			var p=conventPoint2(x,y);
			var feature=new OpenLayers.Feature.Vector(p);
			GpsLineLayer.addFeatures(feature);
			return p;
		}
		
		function addpoint2(x,y){
			var p=conventPoint(x,y);
			var feature=new OpenLayers.Feature.Vector(p);
			GpsLineLayer.addFeatures(feature);
			return p;
		}
		
    </script>
  </head>
  <body onload="init()">
	<div style="width:1024px;height:500px;margin:auto">
    <div id="map" class="smallmap" style="width:1024px;height:500px;margin:auto"></div>
	<textarea id="gd" style="width:624px;height:300px;margin-top:10px"></textarea>
	<button onclick=test()>click</button>
	</div>
  </body>
</html>
