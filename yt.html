<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>货场监控Demo</title>
    <link rel="stylesheet" href="style.css" type="text/css">
	<script src="js/jquery.js"></script>
    <script src="js/OpenLayers-2.12/OpenLayers.js"></script>
	<script src="mapArgs.js"></script>
	<script src="gps1.js"></script>
    <script type="text/javascript">
		   var i=1;
		   var gpsCount=1;
		   var valueTem="";
		   var GpsLineLayer;
		   var pointEndLayer;
		   var temLayer;//放置用于计算的图层
		   var localhost="http://localhost:8080/geoserver";
		
        var map, layer;
        function init(){
		  
            map=loadMap("");
			addGraphicsLayer();
			var mousep=new OpenLayers.Control.MousePosition();
			mousep.displayProjection=new OpenLayers.Projection("EPSG:4326");
			map.addControl(mousep);
			mousep.activate();
        }
		
		function loadMap(name){
			    var bounds = new OpenLayers.Bounds(
                    113.2649917602539, 29.464948654174805,
                    113.27677154541016, 29.48064422607422
                );
				 var bounds1 = new OpenLayers.Bounds(
                    113.26635949312588, 29.45538011497437,
                    113.30276524651514, 29.465135084464226
                ); 
                var options = {
                    controls: [],
                    maxExtent: bounds1,
                    
                    projection: "EPSG:4326",
                    units: 'degrees'
                };
			var loadmap = new OpenLayers.Map( 'map',options);		
			var railway = new OpenLayers.Layer.WMS(
								"Global Imagery",
								localhost+"/wms?service=WMS",
								 {layers: "cite:new"},
								 {singleTile:true}
							);
			temLayer=new OpenLayers.Layer.Vector("tem",{
				strategies: [new OpenLayers.Strategy.BBOX()],
				protocol: new OpenLayers.Protocol.WFS({
                    url: "http://localhost:8080/geoserver/wfs",
                    featureType: "gt_cp",
                    featureNS: "http://www.opengeospatial.net/cite"
                })
			 });
						 
			 loadmap.addLayers([railway,temLayer]);
			 loadmap.addControl(new OpenLayers.Control.PanZoomBar({
                    position: new OpenLayers.Pixel(2, 15)
                }));
                loadmap.addControl(new OpenLayers.Control.Navigation());
                loadmap.addControl(new OpenLayers.Control.Scale($('scale')));
                loadmap.addControl(new OpenLayers.Control.MousePosition({element: $('location')}));
                loadmap.zoomToExtent(bounds);
			 loadmap.setCenter(new OpenLayers.LonLat(113.28510,29.46135),2);
			 

			 return loadmap;
		}
		
		function readyToStartGps(){
			
				window.setInterval(function(){showCurrentGps()},100); 
			
		}
		
		function test(x,y,o){
			
			var point1;
			if(o){
				point1=conventPoint(x,y);
			}
			else{
				 
				 point1=conventPoint2(x,y);
			}
			var feature=new OpenLayers.Feature.Vector(point1);
			pointEndLayer.addFeatures(feature);
			return point1;
			
		}
		
		function conventPoint2(x,y){
			var point=conventPoint(x,y);
			var calcPointArg;
			for(var i in temLayer.features){
				var feature=temLayer.features[i];
				var geometry=feature.geometry;
				
				if(geometry.intersects(point)){
					var id=feature.attributes["Id"];
					var mArgs=mapArgs["a"+id];
					var distanctTop=calcDistance(point.x,point.y,mArgs.p1.yt[0],mArgs.p1.yt[1],mArgs.p4.yt[0],mArgs.p4.yt[1]);
					var distanctButtom=calcDistance(point.x,point.y,mArgs.p2.yt[0],mArgs.p2.yt[1],mArgs.p3.yt[0],mArgs.p3.yt[1]);
					var newY;
					var newX;
					if(distanctTop<distanctButtom){
						var distanct=(distanctTop/mArgs.h.yt)*mArgs.h.ys;
						newY=mArgs.p1.ys[1]-distanctTop;
					}
					else{
						var distanct=(distanctButtom/mArgs.h.yt)*mArgs.h.ys;
						newY=mArgs.p2.ys[1]+distanctButtom;
					}
					if(point.x<mArgs.op.x&&point.y<mArgs.op.y){
						calcPointArg=mArgs.p1;
					}
					else if(point.x<mArgs.op.x&&point.y>mArgs.op.y){
						calcPointArg=mArgs.p2;
					}
					else if(point.x>mArgs.op.x&&point.y>mArgs.op.y){
						calcPointArg=mArgs.p3;
					}
					else if(point.x>mArgs.op.x&&point.y<mArgs.op.y){
						calcPointArg=mArgs.p4;
					}
					var calcPoint=new OpenLayers.Geometry.Point(calcPointArg.yt[0],calcPointArg.yt[1]);
					newX=((point.x-calcPoint.x)/mArgs.w.yt)*mArgs.w.ys+calcPointArg.ys[0];
					return new OpenLayers.Geometry.Point(newX,newY);
				}
			}
		}
		
		
		
		function showCurrentGps(){
			var gpsData=loadGpsData(i);
			if(!gpsData){return;}
			pointEndLayer.removeAllFeatures();
			for(var j in gpsData){
				var gps=gpsData[j];
				var features=GpsLineLayer.getFeaturesByAttribute("id",gps.id);
				var point=conventPoint(gps.lon,gps.lat);
				pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point,{id:gps.id+"号员工"})]);
				
				if(features.length<1){
					
					var featureT=new OpenLayers.Feature.Vector(point);
					featureT.attributes.id=gps.id;
					GpsLineLayer.addFeatures(featureT);
				}
				else{
					var feature=features[0];
					var geometry=feature.geometry;
					var points=geometry.getVertices();
					if(points.length==1){
						var pointO=points[0];
						var newLine=new OpenLayers.Geometry.LineString([pointO,point]);
						var mline=new OpenLayers.Geometry.MultiLineString([newLine]);
						var featureT=new OpenLayers.Feature.Vector(mline);
						featureT.attributes=feature.attributes;
						GpsLineLayer.removeFeatures([feature]);
						GpsLineLayer.addFeatures(featureT);
					}
					else{
						var line=geometry.components[geometry.components.length-1];
						var points=line.getVertices();
						var newLine=new OpenLayers.Geometry.LineString([points[points.length-1],point]);
						geometry.addComponents(newLine);
						var featureT=new OpenLayers.Feature.Vector(geometry);
						featureT.attributes=feature.attributes;
						GpsLineLayer.removeFeatures(features);
						GpsLineLayer.addFeatures(featureT);
					}
				}
			}
			i++;
		}
		
		function addGraphicsLayer(){
			GpsLineLayer=new OpenLayers.Layer.Vector();
			pointEndLayer=new OpenLayers.Layer.Vector("point",{
							styleMap: new OpenLayers.StyleMap({
										"default":new OpenLayers.Style({
													pointRadius:6,
													fillColor: "#ff9933",
													strokeColor: "white",
													strokeWidth: 2,
													label:'${id}',
													labelXOffset: "-15",
													labelYOffset: "15"
												}),	
										"select": new OpenLayers.Style({
													fillColor: "#66ccff",
													strokeColor: "#3399ff",
													graphicZIndex: 2
												})
								})
			});
			map.addLayers([GpsLineLayer,pointEndLayer]);	
		}
		
		function loadGpsData(name){
			var gps=null;
			try{
				gps=eval("gps"+name);
			}
			catch(e){
			}
			return gps;
		}
		
		function calcDistance(p1x,p1y,p0x,p0y,p2x,p2y){
			var p1p0=(p1y-p0y)/(p1x-p0x);
			var p2p0=(p2y-p0y)/(p2x-p0x);
			var p1p0p2=Math.abs(p1p0-p2p0);
			var p12p0=Math.sqrt(Math.pow((p1x-p0x),2)+Math.pow((p1y-p0y),2));
			return p1p0p2*p12p0;
		}
		
		function conventPoint(x,y){
			  var ox=113.264988643;
			  var oy=29.465193982;
			  var sx=2;
			  var sy=23;
			  var rd= 53.1112;
			  var d=rd*Math.PI/180;
			  var tx=(x-ox)*Math.cos(d)+(y-oy)*Math.sin(d)+ox;
			  var ty=-(x-ox)*Math.sin(d)+(y-oy)*Math.cos(d)+oy;
			  
			  var tw=(tx-ox)*sx;
			  var th=(ty-oy)*sy;
			  tx=(ox+tw);
			  ty=(oy+th);
			  var point=new OpenLayers.Geometry.Point(tx,ty);
			  return point;
		}
		
    </script>
  </head>
  <body onload="init()">
	<div style="width:1024px;height:500px;margin:auto">
    <div id="map" class="smallmap" style="width:1024px;height:500px;margin:auto"></div>
	</div>
	<div style="width:1px;height:1px;">
    </div>
	<div id="docs">
        <textarea id="lonlat" style="width:800px;height:800px;"></textarea>
    </div>
  </body>
</html>
