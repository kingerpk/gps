<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>货场监控</title>
    <link rel="stylesheet" href="style.css" type="text/css">
	<script src="js/jquery.js"></script>
    <script src="js/OpenLayers-2.12/OpenLayers.js"></script>
	<script src="gps1.js"></script>
	<script src="gps2.js"></script>
    <script type="text/javascript">
		   var i=1;//测试gps数据用
		   var GpsLineLayer;//gps路线图层
		   var pointEndLayer;//线头，也就是表示那个人当前的位置
		   var mapname="gt";//地图名
		   var localhost="http://localhost:8080/geoserver";
		   var map //地图对象
		   
        function init(){
            map=loadMap();//加载地图
			addGraphicsLayer(map);//加载gps图层
			var mousep=new OpenLayers.Control.MousePosition();//显示鼠标位置的控件
			mousep.displayProjection=new OpenLayers.Projection("EPSG:4214");//
			map.addControl(mousep);
			mousep.activate();
        }
		
		/*
		*加载地图
		*/
		function loadMap(){
			    var bounds = openlayerUtil.getBound(mapname);//获取边界，该方法保存在kingerpk的github中
				var centerPoint=openlayerUtil.getCenter(mapname);//获取中心点，同上
                var options = {
                    maxExtent: bounds,
                    projection: "EPSG:4214",
                    units: 'degrees'
                };
			var loadmap = new OpenLayers.Map('map',options);//初始化地图
			var railway = new OpenLayers.Layer.WMS(
								"Global Imagery",
								localhost+"/wms?service=WMS",
								 {layers: "cite:"+mapname+"_c"},
								 {singleTile:true}
							);//初始化铁路图层
						
			 loadmap.addLayers([railway]);//添加铁路图层
			 loadmap.addControl(new OpenLayers.Control.PanZoomBar({
                    position: new OpenLayers.Pixel(2, 15)
                }));//增加地图导航条
                loadmap.addControl(new OpenLayers.Control.Navigation());
                loadmap.addControl(new OpenLayers.Control.Scale($('scale')));
                loadmap.addControl(new OpenLayers.Control.MousePosition({element: $('location')}));
                loadmap.zoomToExtent(railway.maxExtent,true); //放大地图到合适比例
				loadmap.setCenter(centerPoint,2); //设置中心点
			return loadmap;
		}
		
		/*
		*加载gps图层
		*/
		function addGraphicsLayer(map_to_add){
			GpsLineLayer=new OpenLayers.Layer.Vector();//初始化矢量图层
			pointEndLayer=new OpenLayers.Layer.Vector("point",{
							styleMap: new OpenLayers.StyleMap({
										"default":new OpenLayers.Style({
													pointRadius:2,
													fillColor: "#ff9933",
													strokeColor: "white",
													strokeWidth: 1,
													label:'${id}',
													labelXOffset: "-15",
													labelYOffset: "15"
												}),	
										"select": new OpenLayers.Style({
													fillColor: "#66ccff",
													strokeColor: "#3399ff",
													graphicZIndex: 2
												})
								})//初始化矢量图层
			});
			map_to_add.addLayers([GpsLineLayer,pointEndLayer]);//将矢量图层添加到地图	
		}
		
		/*
		*定时获取gps数据，问题，如果gps数据没有变化，也就是说服务器返回来的数据时旧的，这里是显示还是不显示呢？
		*/
		function readyToStartGps(){
				window.setInterval(function(){showCurrentGps()},1000); 
		}
		
		/*
		*向服务器请求最新的gps数据，然后在地图显示
		*/
		function showCurrentGps(){
			var gpsData=loadGpsData(i);//获取gps数据，这里是模拟的
			if(!gpsData){return;}
			pointEndLayer.removeAllFeatures(); //清空头点
			for(var j in gpsData){
				var gps=gpsData[j];//这里代表一个gps设备的当前位置信息
				var features=GpsLineLayer.getFeaturesByAttribute("id",gps.id);//从gps图层中查找对应id设备号的feature
				
				var point=openlayerUtil.conventPoint(gps.lon,gps.lat,mapname);//根据当前的坐标初始化点
				
				pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point,{id:gps.id+"号员工"})]);
				
				if(features.length<1){
					//如果当前的图层中没有该gps设备的feature，则新加一个点，将其id属性设为改gps设备的id
					var featureT=new OpenLayers.Feature.Vector(point);
					featureT.attributes.id=gps.id;
					GpsLineLayer.addFeatures(featureT);
				}
				else{
					//如果当前图层中有该gps设备的信息的话，那么就要和这些信息连成线
					var feature=features[0];//从图层中查找到的feature
					var geometry=feature.geometry;
					var points=geometry.getVertices();//这个feature的图形是一个折线，从折线中取点
					if(points.length==1){
					    //如果点的数量只有一，那么先将这个旧点和当前的gps点构造成一条线，在构造成折线
						var pointO=points[0];//获取那个唯一的点
						var newLine=new OpenLayers.Geometry.LineString([pointO,point]);//生成线
						var mline=new OpenLayers.Geometry.MultiLineString([newLine]);//构造成折线
						var featureT=new OpenLayers.Feature.Vector(mline);//构造feature
						featureT.attributes=feature.attributes;//设置属性
						GpsLineLayer.removeFeatures([feature]);//将原有的对应该gps设备号的feature移除
						GpsLineLayer.addFeatures(featureT);//将新的添加上去
					}
					else{
					    //如果点的数量不止一个，那么将当前的gps点和上一个点构造成线，然后将这条线加入折线中去
						var line=geometry.components[geometry.components.length-1];//获取折线中的最后一条线
						var points=line.getVertices();//拿到这条线的两个点
						var newLine=new OpenLayers.Geometry.LineString([points[points.length-1],point]);把当前的gps点和这条线的最后一个点组成新的线
						geometry.addComponents(newLine);//将这条线加入到折线中
						var featureT=new OpenLayers.Feature.Vector(geometry);
						featureT.attributes=feature.attributes;
						GpsLineLayer.removeFeatures(features);
						GpsLineLayer.addFeatures(featureT);
					}
				}
			}
			i++;
		}
		
		/*
		*将图层中的feature清除
		*/
		function clearGps(){
			GpsLineLayer.removeAllFeatures();
			pointEndLayer.removeAllFeatures();
		}
		
		/*
		*将给定的一系列gps数据显示在地图上
		*/
		function addGpsData(gpsData){
			if(!gpsData){return;}
			clearGps()；
			for(var j in gpsData){
				var data=gpsData[j];
				var gpss=data.gps;
				var lines=new Array();
				for(var u=0;u<gpss.length-1;u++){
					var point1=openlayerUtil.conventPoint(gpss[u].lon,gpss[u].lat,"gt");
					var point2=openlayerUtil.conventPoint(gpss[u+1].lon,gpss[u+1].lat,"gt");
					var line=new OpenLayers.Geometry.LineString([point1,point2]);
					pointEndLayer.addFeatures([new OpenLayers.Feature.Vector(point1,{id:data.id})]);
					lines.push(line);
				}
				var mLine=new OpenLayers.Geometry.MultiLineString(lines);
				var feature=new OpenLayers.Feature.Vector(mLine);
				GpsLineLayer.addFeatures(feature);

			}
		}
		
		/*
		*获取gps数据
		*/
		function loadGpsData(name){
			var gps=null;
			try{
				gps=eval("gps"+name);
			}
			catch(e){
			}
			return gps;
		}
		
    </script>
  </head>
  <body onload="init()">
	<div style="width:1024px;height:500px;margin:auto">
    <div id="map" class="smallmap" style="width:1024px;height:500px;margin:auto"></div>
	</div>
  </body>
</html>
